 const { cmd } = require('../command');

cmd({
    pattern: "person",
    react: "ğŸ‘¤",
    alias: ["userinfo", "profile"],
    desc: "Get instant user profile info",
    category: "utility",
    filename: __filename
}, async (m, conn) => {
    try {
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 1. CONSTANT DECLARATIONS (All variables defined at top)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const FALLBACK_IMAGE = 'https://i.ibb.co/KhYC4FY/1221bc0bdd2354b42b293317ff2adbcf-icon.png';
        const DEFAULT_BIO = 'No bio available';
        const FOOTER = '> Â© á´˜á´á´¡á´‡Ê€á´‡á´… Ê™Ê á´Ê€ Ò“Ê€á´€É´á´‹';

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 2. TARGET USER RESOLUTION (REPLY > MENTION > SENDER)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const targetUser = m.quoted?.sender || m.mentioned[0] || m.sender;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 3. PARALLEL DATA FETCHING (FASTEST POSSIBLE)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const [userData, profilePic] = await Promise.all([
            conn.onWhatsApp(targetUser).then(res => res[0]),
            conn.profilePictureUrl(targetUser, 'image').catch(() => FALLBACK_IMAGE)
        ]);

        if (!userData?.exists) return m.reply("âŒ User not found " + FOOTER);

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 4. NAME RESOLUTION (GROUP > CONTACT > NUMBER)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const contactName = await conn.getName(targetUser).catch(() => null);
        const groupName = m.isGroup 
            ? m.groupMetadata.participants.find(p => p.id === targetUser)?.notify 
            : null;
        const userName = groupName || contactName || targetUser.split('@')[0];

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 5. BIO/STATUS FETCH (WITH TIMEOUT SAFETY)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const bioFetch = await Promise.race([
            conn.fetchStatus(targetUser),
            new Promise(resolve => setTimeout(resolve, 1500))
        ]);
        const userBio = bioFetch?.status || DEFAULT_BIO;
        const bioUpdateTime = bioFetch?.setAt 
            ? new Date(bioFetch.setAt * 1000).toLocaleString() 
            : null;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 6. GROUP ROLE DETECTION (IF IN GROUP)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const userRole = m.isGroup 
            ? m.groupMetadata.participants.find(p => p.id === targetUser)?.admin 
                ? "ğŸ‘‘ Admin" 
                : "ğŸ‘¥ Member"
            : null;

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 7. COMPILE FINAL MESSAGE (WITH PERFECT FORMATTING)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const finalMessage = `
*ğŸ‘¤ USER PROFILE INFORMATION*

ğŸ†” *Name:* ${userName}
ğŸ“ *Number:* ${targetUser.replace('@s.whatsapp.net', '')}
ğŸ“Œ *Account Type:* ${userData.isBusiness ? 'ğŸ’¼ Business' : 'ğŸ‘¤ Personal'}

ğŸ“ *Bio/Status:*
${userBio}
${bioUpdateTime ? `ğŸ•’ *Updated:* ${bioUpdateTime}` : ''}

${userRole ? `ğŸ‘¥ *Group Role:* ${userRole}` : ''}

ğŸŒ *Chat Link:* https://wa.me/${targetUser.replace('@s.whatsapp.net', '')}

${FOOTER}
`.trim();

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 8. SEND FINAL RESULT (WITH PROPER MENTIONS)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        await conn.sendMessage(m.chat, {
            image: { url: profilePic },
            caption: finalMessage,
            mentions: [targetUser]
        }, { quoted: m });

    } catch (error) {
        const errorMessage = `âŒ Error: ${error.message}\n${FOOTER}`;
        m.reply(errorMessage);
    }
});
